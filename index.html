<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ravandeh Studio — Gallery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .masonry{column-count:1;column-gap:1rem}
    @media (min-width:640px){.masonry{column-count:2}}
    @media (min-width:1024px){.masonry{column-count:3}}
    @media (min-width:1536px){.masonry{column-count:4}}
    .masonry-item{break-inside:avoid;margin-bottom:1rem}
    .fade-in{opacity:0;transform:translateY(8px);transition:opacity .5s,transform .5s}
    .fade-in.show{opacity:1;transform:translateY(0)}
    .postcard{position:relative;overflow:hidden;border-radius:1rem}
    .postcard::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0) 30%,rgba(0,0,0,.55) 100%);opacity:0;transition:opacity .3s}
    .postcard:hover::after{opacity:1}
    .badge{backdrop-filter:blur(6px)}
    dialog::backdrop{background:rgba(0,0,0,.8)}
    dialog{border:none;border-radius:1rem;padding:0;max-width:95vw}
    .lb-img{max-height:85vh;width:auto;height:auto;display:block}
  </style>
</head>
<body class="min-h-screen bg-neutral-50 text-neutral-900">
  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
    <div id="gallery" class="masonry"></div>
    <footer class="text-center text-neutral-500 text-sm mt-12 mb-8">© <span id="year"></span> Ravandeh Studio</footer>
  </main>

  <dialog id="lightbox">
    <div class="bg-black rounded-2xl overflow-hidden">
      <div class="flex items-center justify-between px-4 py-3 text-white">
        <div class="text-sm opacity-80" id="lb-caption"></div>
        <button id="lb-close" class="text-white/80 hover:text-white text-xl leading-none">×</button>
      </div>
      <div class="grid place-items-center bg-black">
        <img id="lb-img" class="lb-img" alt="Expanded" />
      </div>
      <div class="flex justify-between items-center px-4 py-3 bg-black/90 text-white">
        <a id="lb-link" target="_blank" class="underline text-sm">Open on Instagram</a>
        <span class="text-xs bg-white/10 rounded-full px-2 py-1" id="lb-date">—</span>
      </div>
    </div>
  </dialog>

  <script>
    const STATIC_JSON_URL = "media.json"; // IMPORTANT: relative path (no leading slash)

    // Prepend the repo base path so images like "scraped/..." work on GitHub Pages.
    const REPO_BASE = (() => {
      const parts = window.location.pathname.split('/');
      return parts.length > 2 ? `/${parts[1]}/${parts[2]}/` : '/';
    })();
    const withBase = (url) => (url ? REPO_BASE + (url.startsWith('/') ? url.slice(1) : url) : url);

    document.getElementById('year').textContent = new Date().getFullYear();

    const lb = document.getElementById('lightbox');
    const lbImg = document.getElementById('lb-img');
    const lbCaption = document.getElementById('lb-caption');
    const lbDate = document.getElementById('lb-date');
    const lbLink = document.getElementById('lb-link');
    document.getElementById('lb-close').onclick = () => lb.close();
    lb.addEventListener('click', e => { if (e.target === lb) lb.close(); });

    function openLightbox(item) {
      lbImg.src = withBase(item.media_url);
      lbCaption.textContent = item.caption || '';
      lbDate.textContent = new Date(item.timestamp).toLocaleDateString();
      lbLink.href = item.permalink || 'https://www.instagram.com/ravandeh.std/';
      lb.showModal();
    }

    function escapeHtml(s){return (s||'').replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]))}

    function render(items) {
      const root = document.getElementById('gallery');
      root.innerHTML = '';
      for (const item of items) {
        const card = document.createElement('article');
        card.className = 'masonry-item fade-in';
        card.innerHTML = `
          <div class="postcard shadow-[0_10px_25px_rgba(0,0,0,0.08)]">
            <img src="${withBase(item.media_url)}" loading="lazy" alt="" class="w-full block"/>
            <div class="absolute inset-x-0 bottom-0 p-3 text-white flex items-end justify-between">
              <div class="text-sm leading-tight line-clamp-2">${escapeHtml(item.caption || '')}</div>
              <div class="text-xs opacity-80">${new Date(item.timestamp).toLocaleDateString()}</div>
            </div>
          </div>`;
        card.addEventListener('click', () => openLightbox(item));
        root.appendChild(card);
        requestAnimationFrame(() => card.classList.add('show'));
      }
    }

    async function init() {
      try {
        const res = await fetch(STATIC_JSON_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error('media.json not found');
        const data = await res.json();
        render(data);
      } catch (e) {
        document.getElementById('gallery').innerHTML = `
          <div class="p-6 rounded-xl bg-red-50 border border-red-200 text-red-700">
            <div class="font-semibold">Couldn’t load images.</div>
            <div class="text-sm mt-1">Ensure <code>media.json</code> exists and image paths are relative (e.g., <code>scraped/...</code>).</div>
          </div>`;
        console.error(e);
      }
    }
    init();
  </script>
</body>
</html>
